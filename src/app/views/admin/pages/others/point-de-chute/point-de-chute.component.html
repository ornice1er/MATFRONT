<ngx-spinner type="ball-scale-multiple"></ngx-spinner>

<div class="container-fluid" id="container-wrapper" *ngIf="!isLoading">

  <div class="card my-4">
    <div class="card-header p-4 border-0">
      <h4><i class="fas fa-cogs"></i> Configuration des Points de Chute</h4>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label for="pointChutePrincipal">Point de Chute Principal</label>
            <ng-select id="pointChutePrincipal" name="pointChutePrincipal" [(ngModel)]="settings.point_chute_principal"
              [items]="allStructures" bindLabel="libelle" bindValue="id" placeholder="Sélectionnez une structure">
            </ng-select>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label for="pointChuteSecondaire">Points de Chute Secondaires (multi-sélection)</label>
            <ng-select id="pointChuteSecondaire" name="pointChuteSecondaire" [(ngModel)]="settings.point_chute_secondaire"
              [items]="allStructures" bindLabel="libelle" bindValue="id" placeholder="Sélectionnez des structures" [multiple]="true">
            </ng-select>
          </div>
        </div>
      </div>
    </div>
    <div class="card-footer text-right">
      <button class="btn btn-primary" (click)="saveSettings()" [disabled]="isSavingSettings">
        Enregistrer les paramètres
        <app-loading [isVisible]="isSavingSettings"></app-loading>
      </button>
    </div>
  </div>

  <div class="card my-4">
    <div class="card-header p-4 border-0 pt-5">
      <h4><i class="fas fa-list-ul"></i> Liste des Requêtes en Point de Chute</h4>
      <div class="d-flex justify-content-end align-items-center mt-3 gap-2">
        <ng-select [items]="allInstitutions" bindLabel="libelle" bindValue="id" name="filterInstitution"
                   [(ngModel)]="filterInstitutionId" placeholder="Filtrer par entité" class="w-25">
        </ng-select>
        <ng-select [items]="allStructures" bindLabel="libelle" bindValue="id" name="filterStructure"
                   [(ngModel)]="filterStructureId" placeholder="Filtrer par structure" class="w-25">
        </ng-select>
        <button class="btn btn-info btn-sm" (click)="applyFilters()">Appliquer</button>
        <button class="btn btn-secondary btn-sm" (click)="resetFilters()">Réinitialiser</button>
      </div>
    </div>
    <div class="card-body pt-3 pb-0">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <td class="left text-left" colspan="9">
                <button class="btn mx-1 btn-xs btn-danger" (click)="relancer()" [disabled]="!selectedRequete">
                  Relancer
                </button>
                <button class="btn mx-1 btn-xs btn-success" (click)="openAffectationModal(affectationModal)" [disabled]="!selectedRequete">
                  Affecter
                </button>
              </td>
            </tr>
            <tr>
              <th></th>
              <th>Date</th>
              <th>Objet</th>
              <th>Usager</th>
              <th>Entité</th>
              <th>Parcours</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let req of filteredRequetes | sampleSearch:search_text | paginate: { id:'ngxP1', itemsPerPage: pg.pageSize, currentPage: pg.p, totalItems: pg.total }">
              <td>
                <input type="radio" name="getrequete" [value]="req" (change)="checked(req)">
              </td>
              <td>{{ req.created_at | date:'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ req.objet }}</td>
              <td>{{ req.usager?.nom }} {{ req.usager?.prenoms }}</td>
              <td>{{ req.entite?.libelle }}</td>
              <td></td>
            </tr>
            <tr *ngIf="filteredRequetes.length === 0">
              <td colspan="6" class="text-center bg-gray-100">Aucune requête à afficher</td>
            </tr>
          </tbody>
        </table>
        <pagination-controls id="ngxP1" (pageChange)="getPage($event)" previousLabel="Précédent" nextLabel="Suivant"></pagination-controls>
      </div>
    </div>
  </div>
</div>

<ng-template #affectationModal let-modal>
    <div class="modal-header bg-mat-primary d-flex align-items-center">
        <h5 class="modal-title text-white">Affecter une Requête</h5>
        <button type="button" class="close text-white" (click)="modal.dismiss('Cross click')">X</button>
    </div>
    <div class="modal-body">
        <p>Requête sélectionnée : <strong>{{ selectedRequete?.objet }}</strong></p>
        <div class="form-group">
            <label for="affectationStructure">Affecter à la structure :</label>
            <ng-select id="affectationStructure" [items]="allStructures" bindLabel="libelle" bindValue="id"
                       placeholder="Sélectionnez une structure">
            </ng-select>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary">
            <i class="fas fa-save"></i>&nbsp; Valider l'affectation
        </button>
    </div>
</ng-template>